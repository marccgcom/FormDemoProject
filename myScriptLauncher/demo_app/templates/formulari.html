<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Partes de Manteniment – Formulari</title>
  <style>
    /* Base */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:#fff;
      background: radial-gradient(1200px 800px at 50% 30%, #7a122b 0%, #3a0713 55%, #1a040a 100%);}  

    :root{
      --granat:#5a0b1e;
      --granat-2:#8c1d40;
      --teal:#0f6a5b;
      --or:#d5a021;
      --blau:#2e3a8c;
      --radius:18px;
      --shadow:0 10px 25px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06);
      --field-bg: rgba(255,255,255,.08);
      --field-brd: rgba(255,255,255,.18);
      --label:#ffffffd0;
    }

    .page { min-height: 100svh; min-height: 100dvh; display:grid; place-items:center; padding:2vmin; }

    /* Card */
    .card{ width:min(100%,980px); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow); display:grid; }

    /* Grid: mobile ocupa el 100% sense scroll; desktop centrat i sense scroll també */
    @media (max-width:767px){
      .wrapper{ width:100vw; height:100svh; height:100dvh; overflow:hidden; }
      .card{ height:100%; grid-template-rows: auto 1fr auto; }
      /* 8 files (afegim Foto/QR i Codi QR) ocupant el 100% d'alçada */
      .form{ display:grid; grid-template-rows: repeat(8, 1fr); gap:8px; padding:12px; }
      .row{ display:grid; grid-template-columns: 1fr; align-items:center; }
      .label{ font-size:clamp(12px,3.2vw,14px); margin-bottom:6px; color:var(--label); }
      .control{ height:100%; display:flex; }
      .control > *{ flex:1; min-width:0; }
      .actions{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; padding:12px; }
    }

    @media (min-width:768px){
      .card{ padding:22px; }
      .header{ margin-bottom:10px; }
      .form{ display:grid; grid-template-columns: repeat(2, minmax(260px, 1fr)); grid-auto-rows: minmax(72px, 96px); gap:16px; }
      .row{ display:flex; flex-direction:column; justify-content:center; }
      .actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:8px; }
    }

    h1{ margin:16px 16px 0; font-size:clamp(18px,2.6vmin,28px); font-weight:800; letter-spacing:.2px; }
    p.sub{ margin:6px 16px 12px; opacity:.85; font-size:clamp(12px,2vmin,14px); }

    /* Fields */
    label{ font-weight:700; }
    select,input{ appearance:none; -webkit-appearance:none; -moz-appearance:none; }
    .field{ background:var(--field-bg); border:1px solid var(--field-brd); border-radius:12px; padding:12px 14px; color:#fff; outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05); font-size:clamp(14px,2.1vmin,16px); }
    .field::placeholder{ color:#ffffff90; }
    .field:focus{ border-color:#ffffff66; box-shadow:0 0 0 3px #ffffff22, inset 0 1px 0 rgba(255,255,255,.06); }

    .btn{ border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:14px 18px; font-weight:800; letter-spacing:.2px;
      background:linear-gradient(180deg, color-mix(in srgb, var(--bg) 90%, #fff 10%), var(--bg)); box-shadow:var(--shadow);
      transition:transform .2s ease, box-shadow .2s ease; cursor:pointer; }
    .btn:hover{ transform:translateY(-2px); box-shadow:0 16px 30px rgba(0,0,0,.32), inset 0 1px 0 rgba(255,255,255,.06); }
    .btn:active{ transform:translateY(0); }
    .btn--pri{ --bg: var(--granat-2); }
    .btn--sec{ --bg: var(--teal); }

    /* Helper for two datetime side by side on desktop */
    .span-2{ grid-column: span 2; }

    /* Scanner modal full-screen */
    .scanner{ position:fixed; inset:0; background:rgba(0,0,0,.85); display:none; place-items:center; z-index:50; }
    .scanner.active{ display:grid; }
    .scanner .wrap{ position:relative; width:min(100vw, 680px); aspect-ratio:3/4; display:grid; place-items:center; }
    .scanner video{ width:100%; height:100%; object-fit:cover; border-radius:16px; border:2px solid #ffffff22; box-shadow:0 10px 30px rgba(0,0,0,.5); }
    .scanner .hud{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; }
    .scanner .box{ width:60%; aspect-ratio:1/1; border:3px solid #d5a021; border-radius:16px; box-shadow:0 0 0 9999px rgba(0,0,0,.25) inset; }
    .scanner .topbar{ position:absolute; top:10px; left:50%; transform:translateX(-50%); display:flex; gap:8px; }
    .scanner .barbtn{ pointer-events:auto; }

    /* Reduce motion */
    @media (prefers-reduced-motion: reduce){ .btn{ transition:none } }
  </style>
  <!-- jsQR para compatibilidad amplia -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body>
  <div class="page wrapper">
    <section class="card" role="form" aria-labelledby="ttl">
      <header class="header">
        <h1 id="ttl">Part de treball</h1>
        <p class="sub">Introdueix les dades del servei de manteniment.</p>
      </header>

      <form class="form" id="workorder" onsubmit="handleSubmit(event)">
        <!-- Maquina -->
        <div class="row">
          <label class="label" for="maquina">Maquina</label>
          <div class="control">
          {% if maquinaria %}
            <span>{{ maquinaria }}</span>
          {% else %}
            <select id="maquina" name="maquina" class="field" required>
              <option value="Fresadora" selected>Fresadora</option>
              <option value="Torno">Torno</option>
              <option value="CNC">CNC</option>
              <option value="Premsa">Premsa</option>
            </select>
            {% endif %}
          </div>
        </div>

        <!-- Ubicació -->
        <div class="row">
          <label class="label" for="ubicacio">Ubicació</label>
          <div class="control">
            {% if ubicacio %}
              <span>{{ ubicacio }}</span>
              
            {% else %}
                <select id="ubicacio" name="ubicacio" class="field" required>
                  <option value="Alcover" selected>Alcover</option>
                  <option value="Tarragona">Tarragona</option>
                  <option value="Reus">Reus</option>
                  <option value="Valls">Valls</option>
              </select>
            {% endif %}
          </div>
        </div>

        <!-- Trabajador -->
        <div class="row">
          <label class="label" for="trabajador">Treballador</label>
          <div class="control">
            <input id="trabajador" name="trabajador" class="field" type="text" placeholder="Nom i cognoms" required />
          </div>
        </div>

        <!-- Horas dedicadas -->
        <div class="row">
          <label class="label" for="hores">Hores dedicades</label>
          <div class="control">
            <input id="hores" name="hores" class="field" type="number" step="0.25" min="0" placeholder="0,00" inputmode="decimal" required />
          </div>
        </div>

        <!-- Inici -->
        <div class="row">
          <label class="label" for="inici">Data i hora d'inici</label>
          <div class="control">
            <input id="inici" name="inici" class="field" type="datetime-local" required />
          </div>
        </div>

        <!-- Fi -->
        <div class="row">
          <label class="label" for="fi">Data i hora de fi</label>
          <div class="control">
            <input id="fi" name="fi" class="field" type="datetime-local" required />
          </div>
        </div>

        <!-- Foto / QR 
        <div class="row">
          <label class="label" for="qrfile">Foto / QR</label>
          <div class="control" style="gap:8px">
            <input id="qrfile" name="qrfile" class="field" type="file" accept="image/*" capture="environment" />
          </div>
        </div> -->

        <!-- Codi QR (readonly)
        <div class="row">
          <label class="label" for="qrcode">Codi QR (detectat)</label>
          <div class="control" style="gap:8px">
            <input id="qrcode" name="qrcode" class="field" type="text" placeholder="Cap QR llegit encara" readonly />
          </div>
        </div> -->
      </form>

      <div class="actions">
        <button class="btn btn--sec" type="button" onclick="document.getElementById('workorder').reset();document.getElementById('qrcode').value='';">Netejar</button>
        <button class="btn btn--pri" type="button" onclick="openScanner()">Escanejar amb càmera</button>
        <button class="btn btn--pri" type="submit" form="workorder">Guardar</button>
      </div>
    </section>
  </div>

  <div class="scanner" id="scanner">
    <div class="wrap">
      <video id="scanVideo" autoplay playsinline muted></video>
      <div class="hud">
        <div class="topbar">
          <button class="btn btn--sec barbtn" type="button" onclick="closeScanner()">Tancar</button>
          <button class="btn btn--pri barbtn" type="button" onclick="snapAndDetect()">Capturar</button>
        </div>
        <div class="box" aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <!-- Canvas ocult per processar imatges/vídeo amb jsQR -->
  <canvas id="qrCanvas" style="display:none"></canvas>

  <script>
    // Prefilla dates amb ara i +1h
    (function init(){
      const pad = n => String(n).padStart(2,'0');
      const toLocalInput = d => {
        const yyyy = d.getFullYear();
        const mm = pad(d.getMonth()+1);
        const dd = pad(d.getDate());
        const hh = pad(d.getHours());
        const mi = pad(d.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
      };
      const now = new Date();
      const later = new Date(now.getTime()+60*60*1000);
      const i = document.getElementById('inici');
      const f = document.getElementById('fi');
      i.value = toLocalInput(now);
      f.value = toLocalInput(later);
      i.addEventListener('change', () => {
        const iv = new Date(i.value);
        const fv = new Date(f.value);
        if(fv < iv){ f.value = toLocalInput(new Date(iv.getTime()+30*60*1000)); }
        f.min = i.value;
      });
      f.min = i.value;

      // file -> detect
      document.getElementById('qrfile').addEventListener('change', onFileSelected);
    })();

    function handleSubmit(e){
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      const start = new Date(data.inici);
      const end = new Date(data.fi);
      if(end <= start){
        alert("La data de fi ha de ser posterior a l'inici.");
        return;
      }
      console.log('Dades enviades', data);
      alert('Formulari enviat!');
      e.target.reset();
      document.getElementById('qrcode').value = '';
    }

    // --- Detecció QR: natiu (BarcodeDetector) o fallback (jsQR) ---
    const hasBarcode = 'BarcodeDetector' in window;
    let detector;
    if(hasBarcode){
      try { detector = new BarcodeDetector({ formats: ['qr_code'] }); } catch(err){ detector = null; }
    }

    async function readQRFromBitmap(source){
      if(detector){
        const results = await detector.detect(source);
        if(results && results.length){ return results[0].rawValue || ''; }
        throw new Error('No s\'ha trobat cap QR');
      } else if(window.jsQR){
        // source pot ser ImageBitmap, HTMLImageElement, HTMLVideoElement, Canvas
        const canvas = document.getElementById('qrCanvas');
        const ctx = canvas.getContext('2d');
        const w = source.videoWidth || source.width || source.displayWidth || source.naturalWidth || source.width || 0;
        const h = source.videoHeight || source.height || source.displayHeight || source.naturalHeight || source.height || 0;
        if(!w || !h) throw new Error('Imatge sense mida');
        canvas.width = w; canvas.height = h;
        ctx.drawImage(source, 0, 0, w, h);
        const imgData = ctx.getImageData(0, 0, w, h);
        const code = jsQR(imgData.data, imgData.width, imgData.height, { inversionAttempts: 'dontInvert' });
        if(code && code.data){ return code.data; }
        throw new Error('No s\'ha trobat cap QR');
      } else {
        throw new Error('No hi ha suport per lector de QR');
      }
    }

    async function onFileSelected(e){
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      try{
        const bitmap = await createImageBitmap(file);
        const value = await readQRFromBitmap(bitmap);
        document.getElementById('qrcode').value = value;
      }catch(err){
        alert('No s\'ha pogut llegir el QR des de la foto: ' + (err.message || err));
      }
    }

    // --- Escaneig en viu amb càmera ---
    let stream;
    const scannerEl = document.getElementById('scanner');
    const videoEl = document.getElementById('scanVideo');

    async function openScanner(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio:false });
        videoEl.srcObject = stream;
        scannerEl.classList.add('active');
        requestAnimationFrame(tickDetect);
      }catch(err){
        alert('No s\'ha pogut obrir la càmera: ' + (err.message || err));
      }
    }

    async function tickDetect(){
      if(!scannerEl.classList.contains('active')) return;
      try{
        const value = await readQRFromBitmap(videoEl);
        if(value){
          document.getElementById('qrcode').value = value;
          closeScanner();
          return;
        }
      }catch(_){ /* cap QR en aquest frame */ }
      requestAnimationFrame(tickDetect);
    }

    async function snapAndDetect(){
      try{
        const value = await readQRFromBitmap(videoEl);
        if(value){
          document.getElementById('qrcode').value = value;
          closeScanner();
        }
      }catch(err){ console.warn(err); }
    }

    function closeScanner(){
      scannerEl.classList.remove('active');
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      videoEl.srcObject = null;
    }
  </script>
</body>
</html>
