<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Partes de Manteniment – Formulari</title>
  <style>
    /* Base */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:#fff;
      background: radial-gradient(1200px 800px at 50% 30%, #7a122b 0%, #3a0713 55%, #1a040a 100%);}  

    :root{
      --granat:#5a0b1e;
      --granat-2:#8c1d40;
      --teal:#0f6a5b;
      --or:#d5a021;
      --blau:#2e3a8c;
      --green:#1f8a4c;
      --green-2:#2fb36a;
      --radius:18px;
      --shadow:0 10px 25px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06);
      --field-bg: rgba(255,255,255,.08);
      --field-brd: rgba(255,255,255,.18);
      --label:#ffffffd0;
    }

    .page { min-height: 100svh; min-height: 100dvh; display:grid; place-items:center; padding:2vmin; }

    /* Card */
    .card{ width:min(100%,980px); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow); display:grid; }

    @media (max-width:767px){
      .wrapper{ width:100vw; height:100svh; height:100dvh; overflow:hidden; }
      .card{ height:100%; grid-template-rows: auto 1fr auto; }
      .form{ display:grid; grid-template-rows: repeat(8, 1fr); gap:8px; padding:12px; }
      .row{ display:grid; grid-template-columns: 1fr; align-items:center; }
      .label{ font-size:clamp(12px,3.2vw,14px); margin-bottom:6px; color:var(--label); }
      .control{ height:100%; display:flex; align-items:center; }
      .control > *{ flex:1; min-width:0; }
      .actions{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; padding:12px; }
    }

    @media (min-width:768px){
      .card{ padding:22px; }
      .header{ margin-bottom:10px; }
      .form{ display:grid; grid-template-columns: repeat(2, minmax(260px, 1fr)); grid-auto-rows: minmax(72px, 96px); gap:16px; padding:0 16px 16px; }
      .row{ display:flex; flex-direction:column; justify-content:center; }
      .actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:8px; }
    }

    h1{ margin:16px 16px 0; font-size:clamp(18px,2.6vmin,28px); font-weight:800; letter-spacing:.2px; }
    p.sub{ margin:6px 16px 8px; opacity:.85; font-size:clamp(12px,2vmin,14px); }

    /* Pill */
    .pill{ margin:0 16px 12px; display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; font-weight:800; font-size:13px;
      border:1px solid rgba(255,255,255,.18); box-shadow:var(--shadow);
      background:linear-gradient(180deg, color-mix(in srgb, var(--green-2) 85%, #fff 15%), var(--green)); }
    .pill svg{ width:16px; height:16px; flex:0 0 16px }

    label{ font-weight:700; }
    select,input{ appearance:none; -webkit-appearance:none; -moz-appearance:none; }
    .field{ background:var(--field-bg); border:1px solid var(--field-brd); border-radius:12px; padding:12px 14px; color:#fff; outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05); font-size:clamp(14px,2.1vmin,16px); }
    .field::placeholder{ color:#ffffff90; }
    .field:focus{ border-color:#ffffff66; box-shadow:0 0 0 3px #ffffff22, inset 0 1px 0 rgba(255,255,255,.06); }

    .btn{ border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:14px 18px; font-weight:800; letter-spacing:.2px;
      background:linear-gradient(180deg, color-mix(in srgb, var(--bg) 90%, #fff 10%), var(--bg)); box-shadow:var(--shadow);
      transition:transform .2s ease, box-shadow .2s ease; cursor:pointer; }
    .btn:hover{ transform:translateY(-2px); box-shadow:0 16px 30px rgba(0,0,0,.32), inset 0 1px 0 rgba(255,255,255,.06); }
    .btn:active{ transform:translateY(0); }
    .btn--pri{ --bg: var(--granat-2); }
    .btn--sec{ --bg: var(--teal); }

    .span-2{ grid-column: span 2; }

    .scanner{ position:fixed; inset:0; background:rgba(0,0,0,.85); display:none; place-items:center; z-index:50; }
    .scanner.active{ display:grid; }
    .scanner .wrap{ position:relative; width:min(100vw, 680px); aspect-ratio:3/4; display:grid; place-items:center; }
    .scanner video{ width:100%; height:100%; object-fit:cover; border-radius:16px; border:2px solid #ffffff22; box-shadow:0 10px 30px rgba(0,0,0,.5); }
    .scanner .hud{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; }
    .scanner .box{ width:60%; aspect-ratio:1/1; border:3px solid #d5a021; border-radius:16px; box-shadow:0 0 0 9999px rgba(0,0,0,.25) inset; }
    .scanner .topbar{ position:absolute; top:10px; left:50%; transform:translateX(-50%); display:flex; gap:8px; }
    .scanner .barbtn{ pointer-events:auto; }

    @media (prefers-reduced-motion: reduce){ .btn{ transition:none } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body>
  <div class="page wrapper">
    <section class="card" role="form" aria-labelledby="ttl">
      <header class="header">
        <h1 id="ttl">Part de treball</h1>
        <p class="sub">Introdueix les dades del servei de manteniment.</p>

      </header>

      <form class="form" id="workorder" onsubmit="handleSubmit(event)">
        <!-- Maquina -->
        <div class="row">
          <label class="label" for="maquina">Maquina</label>
          <div class="control">
            <span>{{ maquinaria }}</span>
            <input type="hidden" id="maquina" name="maquina" value="{{ maquinaria }}">
          </div>
        </div>

        <!-- Ubicació -->
        <div class="row">
          <label class="label" for="ubicacio">Ubicació</label>
          <div class="control">
            <span>{{ ubicacio }}</span>
            <input type="hidden" id="ubicacio" name="ubicacio" value="{{ ubicacio }}">
          </div>
        </div>
      </form>

      <!-- Pastilla verda d'estat -->
        <div class="pill" role="status" aria-live="polite" aria-label="Lectura guardada">
          <!-- icono check -->
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M20 6L9 17l-5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Lectura Guardada
        </div>

      <!-- Accions ocultes en aquesta vista (si cal, descomenta)
      <div class="actions">
        <button class="btn btn--sec" type="button" onclick="document.getElementById('workorder').reset();">Netejar</button>
        <button class="btn btn--pri" type="button" onclick="openScanner()">Escanejar amb càmera</button>
        <button class="btn btn--pri" type="submit" form="workorder">Guardar</button>
      </div>
      -->
    </section>
  </div>

  <div class="scanner" id="scanner">
    <div class="wrap">
      <video id="scanVideo" autoplay playsinline muted></video>
      <div class="hud">
        <div class="topbar">
          <button class="btn btn--sec barbtn" type="button" onclick="closeScanner()">Tancar</button>
          <button class="btn btn--pri barbtn" type="button" onclick="snapAndDetect()">Capturar</button>
        </div>
        <div class="box" aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <canvas id="qrCanvas" style="display:none"></canvas>

  <script>
    (function init(){
      // Si más adelante vuelves a activar campos de fecha, esto los pre-llenará
      const i = document.getElementById('inici');
      const f = document.getElementById('fi');
      if(i && f){
        const pad = n => String(n).padStart(2,'0');
        const toLocalInput = d => {
          const yyyy = d.getFullYear();
          const mm = pad(d.getMonth()+1);
          const dd = pad(d.getDate());
          const hh = pad(d.getHours());
          const mi = pad(d.getMinutes());
          return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
        };
        const now = new Date();
        const later = new Date(now.getTime()+60*60*1000);
        i.value = toLocalInput(now);
        f.value = toLocalInput(later);
        i.addEventListener('change', () => {
          const iv = new Date(i.value);
          const fv = new Date(f.value);
          if(fv < iv){
            f.value = toLocalInput(new Date(iv.getTime()+30*60*1000));
          }
          f.min = i.value;
        });
        f.min = i.value;
      }
    })();

    function handleSubmit(e){
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      console.log('Dades enviades', data);
      alert('Formulari enviat!');
      e.target.reset();
    }

    const hasBarcode = 'BarcodeDetector' in window;
    let detector;
    if(hasBarcode){
      try { detector = new BarcodeDetector({ formats: ['qr_code'] }); } catch(err){ detector = null; }
    }

    async function readQRFromBitmap(source){
      if(detector){
        const results = await detector.detect(source);
        if(results && results.length){ return results[0].rawValue || ''; }
        throw new Error('No s\'ha trobat cap QR');
      } else if(window.jsQR){
        const canvas = document.getElementById('qrCanvas');
        const ctx = canvas.getContext('2d');
        const w = source.videoWidth || source.width;
        const h = source.videoHeight || source.height;
        if(!w || !h) throw new Error('Imatge sense mida');
        canvas.width = w; canvas.height = h;
        ctx.drawImage(source, 0, 0, w, h);
        const imgData = ctx.getImageData(0, 0, w, h);
        const code = jsQR(imgData.data, imgData.width, imgData.height, { inversionAttempts: 'dontInvert' });
        if(code && code.data){ return code.data; }
        throw new Error('No s\'ha trobat cap QR');
      } else {
        throw new Error('No hi ha suport per lector de QR');
      }
    }

    let stream;
    const scannerEl = document.getElementById('scanner');
    const videoEl = document.getElementById('scanVideo');

    async function openScanner(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio:false });
        videoEl.srcObject = stream;
        scannerEl.classList.add('active');
        requestAnimationFrame(tickDetect);
      }catch(err){
        alert('No s\'ha pogut obrir la càmera: ' + (err.message || err));
      }
    }

    async function tickDetect(){
      if(!scannerEl.classList.contains('active')) return;
      try{
        const value = await readQRFromBitmap(videoEl);
        if(value){
          closeScanner();
          return;
        }
      }catch(_){ }
      requestAnimationFrame(tickDetect);
    }

    async function snapAndDetect(){
      try{
        const value = await readQRFromBitmap(videoEl);
        if(value){
          closeScanner();
        }
      }catch(err){ console.warn(err); }
    }

    function closeScanner(){
      scannerEl.classList.remove('active');
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      videoEl.srcObject = null;
    }
  </script>
</body>
</html>
